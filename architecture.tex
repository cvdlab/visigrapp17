\section{\uppercase{Design and Architecture}}
\label{sec:architecture}

% principles
\noindent Workflow and requirements described in the previous section have been received in \emph{Metior}, a prototypal application serving as proof of concept. With the aim of maximize accessibility for surveyors, it is strongly web based and runs in modern browsers. it is built using React by Facebook and an MVC design pattern with \emph{unidirectional data flow} \cite{redux}:  it ensures the best code maintainability and debuggability by centralizing access to the application state to a single controller.

\subsection{UI \& UX}

The web application appears as a simplified CAD.

\begin{figure}[htbp] %  figure placement: here, top, bottom, or page
   \centering

   \includegraphics[width=1\linewidth]{images/ui}

   \caption{\emph{Meteor} user interface}
   \label{fig:ui}
\end{figure}

L'interfaccia utente si compone di 3 aree principali:
- toolbar
- canvas
- sidebar

Dalla toolbar è possibile richiamare le funzionalità per:
- gestire il ciclo di vita di un progetto (nuovo, carica, salva),
- editare il progetto (aprire il catalogo di elementi architetturali da disegnare)
- cambiare la modalità di visualizzazione (2D \& 3D)
- cambiare le modalità di interazione (pan \& zoom)

La canvas presenta il progetto nelle differenti modalità di visualizzazione
- modalità 2D, vista dall'alto, in cui è possibile inserire/selezionare elementi
- modalità 3D, vista esterna prospettica o ortografica, in cui e possibile selezionare elementi
- modalità 3D, vista in prima person, in cui è possibile navigare il progetto

La sidebar presenta le proprietà specifiche dell'elemento correntemente selezionato.
Attraverso tale pannello è possibile visualizzare la descrizione dell'elemento,
modificare le proprietà dell'elemento, aggiungere/modificare/rimuovere metadati.

\subsection{Plugin-architecture}

\noindent The application has been designed to provide a small set of core interaction functionalities and to encapsulate the generation logic for architectural components (from the very basic to the most articulated) into specific plugins.

Un plugin è un componente software che può essere integrato nel sistema e che ne estende le capacità.
In Metior, un plugin rappresenta un elemento architetturale che estende la capacità di progettazione di un edificio.
Tecnicamente, un plugin rappresenta un prototipo (in programmazione orientata agli oggetti, una "classe") di un elemento architettonico, che può essere inserito ("instanziato") all'interno di un progetto.

\subsubsection{Definizione di un plugin}

Un plugin viene definito dalle seguenti proprietà:
\begin{itemize}
\item un nome univoco
\item una descrizione testuale
\item metadati
\item la tipologia del plugin, che può essere "linear", "area" o "volume"
\item le possibilità di posizionamento del plugin, che può essere "inside" o "over"
\item le proprietà specifiche dell'oggetto descritto dal plugin
\item una funzione che riporta una rappresentazione 2D dell'elemento (per la vista 2D)
\item una funzione che riporta una rappresentazione 3D dell'elemento (per la vista 3D)
\end{itemize}

\subsubsection{Tassonomia dei plugin}\label{ssec:taxonomy}

I plugin possono essere organizzati in base alla loro tipologia e possibilità di posizionamento.

Gli elementi di tipo "linear" rappresentano elementi che si estendono in una dimensione (a meno di uno spessore), come ad esempio i condotti idraulici o i cavi elettrici.

Gli elementi di tipo "area" rappresentano elementi che si estendono in due dimensioni (a meno di uno spessore), ovvero gli elementi di separazione.
Questi si distinguono in "horizontal", come ad esempio i pavimenti o i solai, e "vertical", come ad esempio le pareti.

Gli elementi di tipo "volume" rappresentano elementi che si estendono nelle tre dimensioni.
Questi si distinguono in "fixed", ovvero che hanno dimensioni fisse, come ad esempio i componenti di arredo,
e "scalable", ovvero che hanno dimensioni scalabili (in modo proporzionale, o non), come ad esempio i pilastri.

Ciascun tipo determina una modalità di instanziazione ed interazine differente, ovvero una modalità di inserimento e di modifica dell'istanza nella canvas.
Nello specifico, nella modalità 2D,
gli elementi di tipo "linear" sono inseriti disegnando drag\&drop linee,
gli elementi di tipo "area" sono inseriti disegnado drag\&drop il bounding-box dell'elemento,
gli elementi di tipo "volume" sono inseriti specificando point\&click la posizione dell'elemento,
e variando le sue dimensioni allargando drag\&drop il bounding-box dell'elemento.

Ciascuna possibilità di posizionamento di un plugin determina la fattibilità di inserimento dell'istanza del plugin all'interno della canvas.

Gli elementi di tipo "inside" possono essere inseriti solo all'interno di altri elementi di tipo "linear", "area" o "volume".
Ad esempio, una finestra è un elemento di tipo "volume inside vertical area",
un condotto idraulico può essere un elemento di tipo "linear inside horizontal area".

Gli elementi di tipo "over" possono essere inseriti solo a fianco di altri elementi di tipo "linear", "area" o "volume".
Ad esempio, un pilastro è un elmento di tipo "volume over horizontal area",
un pannello elettrico è un elemento di tipo "volume over vertical area".

Nella fase di progettazione, un elemento che non rispetta il vincolo definito dalla sua possibilità di posizionamento è rilevato come warning visivo (bounding-box di colore rosso) dal sistema.

\subsubsection{Proprietà specifiche dei plugin}

Ciascun plugin ha un insieme di proprietà specifiche dell'elemento che rappresenta.
Ciascuna proprietà è definita da:
- un nome
- un tipo, che può essere "number", "text", "boolean", o "custom"
- un valore

Ciascun tipo di proprietà descrive e determina una modalità di inserimento del valore specifica.
Ad esempio, un tipo "boolean" è definito da una "checkbox", un tipo "text" da una casella di testo.
Il sistema permette di definire nuovi tipi di dato, specificando l'interfaccia di inserimento del valore.
Ad esempio, un tipo "color" può essere definito da tre caselle numeriche che rappresentano le componenti di colore RGB,
oppure un tipo "lunghezza" può essere definito da una casella numerica che rappresenta il valore e da un menu a tendina
per specificare l'unità di misura.

Le proprietà di un istanza di un plugin sono editabili dal pannello presente nella sidebar quando l'istanza è selezionata.


\subsection{Plugin Catalog}
\noindent It is pivotal to provide surveyors with a rich catalog of plugins, to cover all the basic as well as the most advanced modeling requirements. Table~\ref{tab:plugins-example} reports examples of plugins arranged by the introduced taxonomy.
 
\begin{table}[htbp]
\small
\centering
\begin{tabular}{|
>{\columncolor[HTML]{EFEFEF}}l |l|l|}
\hline
{\color[HTML]{000000} } & \cellcolor[HTML]{EFEFEF}{\color[HTML]{000000} \footnotesize{\bf{inside}}} & \cellcolor[HTML]{EFEFEF}{\color[HTML]{000000} \footnotesize{\bf{over / free}}} \\ \hline
\footnotesize{\bf{linear}}         & \tt{pipe}                   & \tt{electrical-conduit}              \\ \hline
\footnotesize{\bf{ver. area}}    & \tt{window, door}     & \tt{wall}                                   \\ \hline
\footnotesize{\bf{hor. area}}    & \tt{light-panel}         & \tt{ground, ceil}                     \\ \hline
\footnotesize{\bf{volume}}      & \tt{pillar}                  & \tt{staircase}                           \\ \hline
\end{tabular}
\caption{Plugins example according to taxonomy~\ref{ssec:taxonomy}}
\label{tab:plugins-example}
\end{table}

\subsection{Server-side models generation}

\noindent Both 3D and 2D model generation has been designed to be asynchronous: the actual result of the invocation of the generation function is not the model itself but rather a \emph{promise} of the expected result. Such a design is important since the computation for model generation may require a while. In the meantime the user must be able to interact with the interface, which in turn must remain responsive. Relying on this architecture, generation of the models can be easily delegated to a server (as shown in Figure~\ref{fig:c-s-arch}), thus relieving the client from the burden of onerous computations. The server exposes a REST-like HTTP based JSON API to the client. The plugin span from the client to the server since the 2D and 3D generation functions (``3Dgf'' and ``2Dgf'' respectively in Figure~\ref{fig:c-s-arch}) defined by the plugin are actually executed on the server.

\begin{figure}[htbp] %  figure placement: here, top, bottom, or page
   \centering

   \includegraphics[width=0.6\linewidth]{images/architecture}

   \caption{Client/Server architecture for server-side models generation}
   \label{fig:c-s-arch}
\end{figure}




\noindent









